# =============================================================================
# NGINX SECURITY CONFIGURATION FOR PERPUSTAKAAN UNIDA
# =============================================================================
# Copy this to /etc/nginx/snippets/security.conf
# Then include in your server block: include snippets/security.conf;
# =============================================================================

# -----------------------------------------------------------------------------
# RATE LIMITING ZONES (put in http block)
# -----------------------------------------------------------------------------
# limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
# limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
# limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;

# -----------------------------------------------------------------------------
# BLOCK SUSPICIOUS USER AGENTS
# -----------------------------------------------------------------------------
if ($http_user_agent ~* (sqlmap|nikto|nmap|masscan|zgrab|python-requests|scrapy|libwww-perl|curl/|wget/)) {
    return 403;
}

# Block empty user agents
if ($http_user_agent = "") {
    return 403;
}

# -----------------------------------------------------------------------------
# BLOCK SUSPICIOUS REQUEST METHODS
# -----------------------------------------------------------------------------
if ($request_method !~ ^(GET|HEAD|POST|PUT|PATCH|DELETE)$) {
    return 405;
}

# -----------------------------------------------------------------------------
# BLOCK SUSPICIOUS QUERY STRINGS (SQL Injection, XSS)
# -----------------------------------------------------------------------------
set $block_sql_injections 0;
if ($query_string ~ "union.*select.*\(") { set $block_sql_injections 1; }
if ($query_string ~ "concat.*\(") { set $block_sql_injections 1; }
if ($query_string ~ "drop.*table") { set $block_sql_injections 1; }
if ($query_string ~ "insert.*into.*values") { set $block_sql_injections 1; }
if ($block_sql_injections = 1) { return 403; }

set $block_xss 0;
if ($query_string ~ "<script") { set $block_xss 1; }
if ($query_string ~ "javascript:") { set $block_xss 1; }
if ($query_string ~ "vbscript:") { set $block_xss 1; }
if ($block_xss = 1) { return 403; }

# -----------------------------------------------------------------------------
# BLOCK GAMBLING/JUDOL KEYWORDS IN URL
# -----------------------------------------------------------------------------
if ($request_uri ~* (slot.?gacor|judi.?online|togel|sbobet|poker.?online|casino.?online)) {
    return 403;
}

# -----------------------------------------------------------------------------
# BLOCK DIRECT IP ACCESS
# -----------------------------------------------------------------------------
# Uncomment if you want to block direct IP access
# if ($host !~ ^(perpustakaan\.unida\.gontor\.ac\.id|library\.unida\.gontor\.ac\.id)$) {
#     return 444;
# }

# -----------------------------------------------------------------------------
# SECURITY HEADERS
# -----------------------------------------------------------------------------
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

# Remove server version
server_tokens off;

# -----------------------------------------------------------------------------
# LIMIT REQUEST SIZE
# -----------------------------------------------------------------------------
client_max_body_size 64M;
client_body_buffer_size 128k;

# -----------------------------------------------------------------------------
# PROTECT SENSITIVE FILES
# -----------------------------------------------------------------------------
location ~ /\.(?!well-known) {
    deny all;
}

location ~ /\.(env|git|htaccess|htpasswd|ini|log|sh|sql|bak|old|orig|swp)$ {
    deny all;
}

location ~ ^/(artisan|composer\.(json|lock)|package\.json|webpack\.mix\.js)$ {
    deny all;
}

# -----------------------------------------------------------------------------
# PROTECT ADMIN PANEL (Filament)
# -----------------------------------------------------------------------------
location /admin {
    # Uncomment and add your IPs to whitelist
    # allow 103.195.19.0/24;  # Office IP
    # allow 180.72.81.0/24;   # Your IP
    # deny all;
    
    try_files $uri $uri/ /index.php?$query_string;
}

# -----------------------------------------------------------------------------
# RATE LIMIT LOGIN ENDPOINTS
# -----------------------------------------------------------------------------
location ~ ^/(login|register|password) {
    limit_req zone=login burst=3 nodelay;
    try_files $uri $uri/ /index.php?$query_string;
}

# -----------------------------------------------------------------------------
# RATE LIMIT API
# -----------------------------------------------------------------------------
location /api {
    limit_req zone=api burst=50 nodelay;
    try_files $uri $uri/ /index.php?$query_string;
}

# -----------------------------------------------------------------------------
# BLOCK PHP IN UPLOADS
# -----------------------------------------------------------------------------
location ~* /storage/.*\.php$ {
    deny all;
}

location ~* /uploads/.*\.php$ {
    deny all;
}
